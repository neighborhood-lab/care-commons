name: discord notification

on:
  workflow_run:
    workflows: ["CI", "Deploy"]
    types:
      - completed
    branches:
      - develop
      - preview
      - main

concurrency:
  group: notifications-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    if: always() && ((github.event.workflow_run.name == 'CI' && github.event.workflow_run.head_branch == 'develop') || (github.event.workflow_run.name == 'Deploy'))
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Check previous run status
        id: check_previous
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.payload.workflow_run.workflow_id,
              branch: context.payload.workflow_run.head_branch,
              per_page: 5
            });
            
            const currentRun = context.payload.workflow_run;
            const previousRuns = runs.data.workflow_runs.filter(r => 
              r.id !== currentRun.id && 
              r.created_at < currentRun.created_at &&
              r.conclusion !== 'skipped' &&
              r.conclusion !== 'cancelled'
            );
            
            const previousRun = previousRuns[0];
            const wasRed = previousRun && previousRun.conclusion === 'failure';
            const isGreen = currentRun.conclusion === 'success';
            const isRed = currentRun.conclusion === 'failure';
            const isRecovery = wasRed && isGreen;
            
            core.setOutput('was_red', wasRed);
            core.setOutput('is_green', isGreen);
            core.setOutput('is_red', isRed);
            core.setOutput('is_recovery', isRecovery);
            
            console.log(`Previous: ${previousRun?.conclusion || 'none'}, Current: ${currentRun.conclusion}`);
            console.log(`Recovery: ${isRecovery}, Red: ${isRed}`);

      - name: Send Discord notification
        if: ${{ env.DISCORD_WEBHOOK_URL != '' && (steps.check_previous.outputs.is_recovery == 'true' || steps.check_previous.outputs.is_red == 'true' || github.event.workflow_run.name == 'Deploy') }}
        run: |
          if [ -z "${{ env.DISCORD_WEBHOOK_URL }}" ]; then
            echo "‚ùå DISCORD_WEBHOOK_URL is empty - skipping notification"
            exit 0
          fi
          
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          
          # Determine message based on workflow type and status
          if [ "${{ github.event.workflow_run.name }}" == "Deploy" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              MESSAGE="üöÄ **Deployed to ${{ github.event.workflow_run.head_branch }}** (${SHORT_SHA})"
            else
              MESSAGE="‚ùå **Deploy FAILED** on \`${{ github.event.workflow_run.head_branch }}\` (${SHORT_SHA}) - <${{ github.event.workflow_run.html_url }}>"
            fi
          elif [ "${{ steps.check_previous.outputs.is_recovery }}" == "true" ]; then
            MESSAGE="‚úÖ **Build RECOVERED** on \`develop\` (${SHORT_SHA})"
          else
            MESSAGE="‚ùå **CI FAILED** on \`develop\` (${SHORT_SHA}) - <${{ github.event.workflow_run.html_url }}>"
          fi
          
          curl -s -w "\nHTTP Status: %{http_code}\n" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"${MESSAGE}\"}" \
            "${{ env.DISCORD_WEBHOOK_URL }}" > /tmp/discord-response.txt
          
          HTTP_CODE=$(tail -n1 /tmp/discord-response.txt | grep -o '[0-9]*$')
          
          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Discord notification failed (HTTP $HTTP_CODE)"
            cat /tmp/discord-response.txt
            exit 1
          fi

      - name: Discord not configured
        if: ${{ env.DISCORD_WEBHOOK_URL == '' }}
        run: |
          echo "‚ÑπÔ∏è Discord notifications not configured (this is expected)"
          exit 0
