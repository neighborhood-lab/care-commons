name: Deploy

on:
  push:
    branches:
      - production  # Production deployments
      - preview     # Preview deployments (preview branch uses Vercel preview environment)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - preview
          - production
      deploy_type:
        description: 'Deployment type'
        required: true
        type: choice
        default: 'standard'
        options:
          - standard
          - hotfix
          - rollback
      skip_tests:
        description: 'Skip tests (hotfix/rollback only - use sparingly!)'
        required: false
        type: boolean
        default: false
      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '22'
  NPM_VERSION: '10.9.4'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Pre-deployment Validation
        run: |
          echo "::group::Deployment Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/production' && 'production' || 'preview') }}"
          echo "Deploy Type: ${{ github.event.inputs.deploy_type || 'standard' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Skip Tests: ${{ github.event.inputs.skip_tests || 'false' }}"
          echo "Run Migrations: ${{ github.event.inputs.run_migrations || 'true' }}"
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "::endgroup::"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm 10.9.4
        run: npm install -g npm@10.9.4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install dependencies
        run: npm ci || (npm cache clean --force && npm ci)

      - name: Build packages
        run: |
          echo "::group::Building packages"
          START_TIME=$(date +%s)
          npx turbo run build
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… Build completed in ${DURATION}s"
          echo "::endgroup::"

      - name: Run tests
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          echo "::group::Running tests"
          START_TIME=$(date +%s)
          npx turbo run test
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… Tests completed in ${DURATION}s"
          echo "::endgroup::"

      - name: Skip tests warning
        if: ${{ github.event.inputs.skip_tests == 'true' }}
        run: |
          echo "::warning::Tests skipped - use only for hotfixes or rollbacks!"
          echo "Deploy type: ${{ github.event.inputs.deploy_type }}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: packages/*/dist
          retention-days: 1

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/preview') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preview')
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm 10.9.4
        run: npm install -g npm@10.9.4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Install dependencies
        run: npm ci || (npm cache clean --force && npm ci)

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Verify Database URL
        run: |
          if [ -z "${{ secrets.PREVIEW_DATABASE_URL }}" ]; then
            echo "âŒ ERROR: PREVIEW_DATABASE_URL secret is not set"
            echo "Please add PREVIEW_DATABASE_URL to GitHub Secrets:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          echo "âœ… Database URL is configured"

      - name: Run Database Migrations (Preview)
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "ğŸ“¦ Running database migrations..."
          npm run db:migrate
          echo "âœ… Migrations complete"

      - name: Verify Database State (Preview)
        env:
          PREVIEW_DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying preview database state..."
          tsx scripts/verify-database-state.ts --preview
          echo "âœ… Verification complete"

      - name: Build for Preview
        env:
          NODE_ENV: production
        run: npx turbo run build

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --env DATABASE_URL="${{ secrets.PREVIEW_DATABASE_URL }}" --env ENVIRONMENT="preview")
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Preview deployment complete: $DEPLOYMENT_URL"
        env:
          ENVIRONMENT: preview

      - name: Post-Deployment Validation (Preview)
        if: success()
        run: |
          echo "::group::Validating preview deployment"
          ./scripts/validate-deployment.sh "${{ steps.deploy.outputs.url }}" preview
          echo "::endgroup::"

      - name: Deployment Summary
        run: |
          echo "âœ… Preview deployment complete"
          echo "URL: ${{ steps.deploy.outputs.url }}"
          echo ""
          echo "âš ï¸  Preview is OAuth protected - manual verification required:"
          echo "   1. Visit ${{ steps.deploy.outputs.url }}"
          echo "   2. Authenticate with GitHub"
          echo "   3. Verify health endpoint: ${{ steps.deploy.outputs.url }}/health"
          echo "   4. Test login flow and navigation"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/production') ||
      (github.event_name == 'workflow_dispatch')
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm 10.9.4
        run: npm install -g npm@10.9.4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Install dependencies
        run: npm ci || (npm cache clean --force && npm ci)

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Verify Database URL
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "âŒ ERROR: DATABASE_URL secret is not set"
            echo "Please add DATABASE_URL to GitHub Secrets:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          echo "âœ… Database URL is configured"

      - name: Run Database Migrations (Production)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ“¦ Running database migrations..."
          npm run db:migrate
          echo "âœ… Migrations complete"

      - name: Verify Database State (Production)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying production database state..."
          tsx scripts/verify-database-state.ts --production
          echo "âœ… Verification complete"

      - name: Build for Production
        env:
          NODE_ENV: production
        run: npx turbo run build

      - name: Deploy to Vercel Production
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --env DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --env STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}" \
            --env STRIPE_WEBHOOK_SECRET="${{ secrets.STRIPE_WEBHOOK_SECRET }}" \
            --env RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}" \
            --env ENVIRONMENT="production")
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Production deployment complete: $DEPLOYMENT_URL"
        env:
          ENVIRONMENT: production

      - name: Post-Deployment Validation (Production)
        if: success()
        run: |
          echo "::group::Validating production deployment"
          ./scripts/validate-deployment.sh "https://care-commons.vercel.app" production
          echo "::endgroup::"

      - name: Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Production Deployment Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "URL: https://care-commons.vercel.app"
          echo "Health Check: https://care-commons.vercel.app/health"
          echo ""
          echo "Database: Reset and seeded with comprehensive demo data"
          echo "Validation Status: See post-deployment checks above"
          echo ""

  deployment-health-check:
    name: Verify Deployment Health
    runs-on: ubuntu-latest
    needs: [deploy-preview, deploy-production]
    if: always() && (needs.deploy-preview.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: Wait for deployment to stabilize
        run: |
          echo "â³ Waiting 30 seconds for deployment to stabilize..."
          sleep 30

      - name: Health Check with Retry
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-production.outputs.url || needs.deploy-preview.outputs.url }}"

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âš ï¸ No deployment URL available, skipping health check"
            exit 0
          fi

          echo "ğŸ” Checking health endpoint: $DEPLOYMENT_URL/health"

          # Try health check with retry
          for i in {1..5}; do
            if curl -f -s "$DEPLOYMENT_URL/health" > /tmp/health-response.json; then
              echo "âœ… Health check passed on attempt $i"
              echo "Response:"
              cat /tmp/health-response.json | jq '.' || cat /tmp/health-response.json
              exit 0
            fi
            echo "âš ï¸ Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done

          echo "::warning::Health check failed after 5 attempts"
          echo "Note: This may be normal if health endpoint requires authentication"
          exit 0

      - name: Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Deployment Status Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Preview: ${{ needs.deploy-preview.result }}"
          echo "Production: ${{ needs.deploy-production.result }}"
          echo "Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"