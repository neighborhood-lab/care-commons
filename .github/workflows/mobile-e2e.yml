# Mobile E2E Testing with Maestro
#
# Runs automated mobile app tests on iOS and Android
# using Maestro framework in GitHub Actions CI/CD pipeline
#
# Triggers:
# - Pull requests affecting mobile package
# - Push to main branches
# - Manual workflow dispatch

name: Mobile E2E Tests

on:
  pull_request:
    paths:
      - 'packages/mobile/**'
      - 'packages/core/**'
      - 'verticals/time-tracking-evv/**'
      - '.github/workflows/mobile-e2e.yml'
  push:
    branches:
      - production
      - preview
      - develop
    paths:
      - 'packages/mobile/**'
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test on iOS Simulator
  test-ios:
    name: iOS E2E Tests
    runs-on: macos-14 # Latest macOS with Apple Silicon support
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: packages/mobile

      - name: Setup Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: maestro --version

      - name: Setup Expo
        run: npm install -g expo-cli eas-cli

      - name: Setup iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices available

          # Boot iPhone 15 Pro simulator (adjust based on available devices)
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | grep -o "[0-9A-F-]\{36\}")

          if [ -z "$SIMULATOR_ID" ]; then
            echo "Creating iPhone 15 Pro simulator..."
            SIMULATOR_ID=$(xcrun simctl create "iPhone 15 Pro Test" "iPhone 15 Pro" "iOS17.5")
          fi

          echo "Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true

          # Wait for simulator to boot
          xcrun simctl bootstatus "$SIMULATOR_ID" -b

          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV

      - name: Build iOS app for testing
        working-directory: packages/mobile
        run: |
          # Build debug version for simulator
          npx expo run:ios --device
        env:
          EXPO_NO_DOTENV: 1
        continue-on-error: true # First build may fail, retry with prebuild

      - name: Prebuild and retry iOS build if needed
        if: failure()
        working-directory: packages/mobile
        run: |
          npx expo prebuild --platform ios --clean
          npx expo run:ios --device

      - name: Run Maestro E2E tests
        working-directory: packages/mobile
        run: |
          # Run comprehensive test suite
          maestro test \
            --format junit \
            --output test-results/maestro-ios-report.xml \
            .maestro/flows/00-comprehensive-suite.yaml
        continue-on-error: true # Don't fail immediately, upload results first

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-ios-results
          path: |
            packages/mobile/test-results/
            packages/mobile/.maestro/screenshots/
          retention-days: 7

      - name: Upload visual regression screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-ios
          path: packages/mobile/.maestro/visual-regression/
          retention-days: 30

      - name: Publish test report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'packages/mobile/test-results/maestro-ios-report.xml'
          check_name: 'iOS E2E Test Results'
          fail_on_failure: true

  # Test on Android Emulator
  test-android:
    name: Android E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: packages/mobile

      - name: Setup Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: maestro --version

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Expo
        run: npm install -g expo-cli eas-cli

      - name: Enable KVM (for faster emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          ram-size: 4096M
          heap-size: 512M
          disk-size: 8G
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            echo "Emulator started successfully"
            adb devices

      - name: Build Android app for testing
        working-directory: packages/mobile
        run: |
          # Build debug version for emulator
          npx expo run:android --device
        env:
          EXPO_NO_DOTENV: 1
        continue-on-error: true # First build may fail, retry with prebuild

      - name: Prebuild and retry Android build if needed
        if: failure()
        working-directory: packages/mobile
        run: |
          npx expo prebuild --platform android --clean
          npx expo run:android --device

      - name: Run Maestro E2E tests on Android
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          script: |
            cd packages/mobile
            maestro test \
              --format junit \
              --output test-results/maestro-android-report.xml \
              .maestro/flows/00-comprehensive-suite.yaml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-android-results
          path: |
            packages/mobile/test-results/
            packages/mobile/.maestro/screenshots/
          retention-days: 7

      - name: Upload visual regression screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-android
          path: packages/mobile/.maestro/visual-regression/
          retention-days: 30

      - name: Publish test report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'packages/mobile/test-results/maestro-android-report.xml'
          check_name: 'Android E2E Test Results'
          fail_on_failure: true

  # Performance test job (runs separately)
  performance-test:
    name: Performance Tests
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: packages/mobile

      - name: Setup Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Setup iOS Simulator
        run: |
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | grep -o "[0-9A-F-]\{36\}")
          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl create "iPhone 15 Pro Test" "iPhone 15 Pro" "iOS17.5")
          fi
          xcrun simctl boot "$SIMULATOR_ID" || true
          xcrun simctl bootstatus "$SIMULATOR_ID" -b

      - name: Build app
        working-directory: packages/mobile
        run: npx expo run:ios --device
        continue-on-error: true

      - name: Run performance tests
        working-directory: packages/mobile
        run: |
          maestro test \
            --format junit \
            --output test-results/performance-report.xml \
            .maestro/flows/07-performance.yaml

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: |
            packages/mobile/test-results/
            packages/mobile/.maestro/performance/
          retention-days: 30

      - name: Comment PR with performance metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            // Parse performance metrics and post to PR
            // This would read the test results and format them
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ“Š Mobile Performance Test Results\n\nPerformance tests completed. Check artifacts for detailed metrics.'
            });
